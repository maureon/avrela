<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScmEvaluationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">avrela</a> &gt; <a href="index.source.html" class="el_package">es.ubu.lsi.avrela.css.port</a> &gt; <span class="el_source">ScmEvaluationService.java</span></div><h1>ScmEvaluationService.java</h1><pre class="source lang-java linenums">package es.ubu.lsi.avrela.css.port;

import es.ubu.lsi.avrela.apm.adapter.github.GitHubApmClient;
import es.ubu.lsi.avrela.css.adapter.web.ScmWebRubricEvaluation;
import es.ubu.lsi.avrela.css.adapter.web.WebHistoricalScmData;
import es.ubu.lsi.avrela.css.adapter.web.WebRubricCriteriaEvaluation;
import es.ubu.lsi.avrela.css.adapter.web.WebScmCaseStudySimulation;
import es.ubu.lsi.avrela.css.model.CommitComparison;
import es.ubu.lsi.avrela.css.model.Rubric;
import es.ubu.lsi.avrela.css.model.ScmCaseStudySimulation;
import es.ubu.lsi.avrela.css.util.RubricDataGenerator;
import es.ubu.lsi.avrela.scm.adapter.github.GitHubCommitRepository;
import es.ubu.lsi.avrela.scm.adapter.github.GitHubHistoricalScmDataRepository;
import es.ubu.lsi.avrela.scm.adapter.github.GitHubScmClient;
import es.ubu.lsi.avrela.scm.adapter.github.mapper.GitHubCommitFileMapper;
import es.ubu.lsi.avrela.scm.adapter.github.mapper.GitHubCommitMapper;
import es.ubu.lsi.avrela.scm.model.CommitSimilarity;
import es.ubu.lsi.avrela.scm.model.CommitSimilarity.Feature;
import es.ubu.lsi.avrela.scm.model.HistoricalScmData;
import feign.Logger.Level;
import java.util.EnumMap;
import java.util.List;
import lombok.extern.slf4j.Slf4j;

<span class="nc" id="L25">@Slf4j</span>
<span class="nc" id="L26">public class ScmEvaluationService {</span>

<span class="nc" id="L28">  private ScmCriteriaService scmCriteriaService = new ScmCriteriaService();</span>

<span class="nc" id="L30">  private WebHistoricalScmDataMapper webHistorialScmDataMapper = new WebHistoricalScmDataMapper();</span>

  public WebScmCaseStudySimulation evaluate (WebScmCaseStudySimulation  scmCss){
    // Init GitHubClient
<span class="nc" id="L34">    GitHubScmClient gitHubScmClient = GitHubScmClient.with(Level.BASIC);</span>
<span class="nc" id="L35">    GitHubApmClient gitHubApmClient = GitHubApmClient.with(Level.BASIC);</span>

<span class="nc" id="L37">    GitHubCommitRepository commitRepository = new GitHubCommitRepository(gitHubScmClient, gitHubApmClient, new GitHubCommitMapper(new GitHubCommitFileMapper()));</span>

    HistoricalScmData caseStudy, simulation;

<span class="nc" id="L41">    GitHubHistoricalScmDataRepository scmHistoricalDataRepository = new GitHubHistoricalScmDataRepository(commitRepository);</span>

<span class="nc" id="L43">    WebHistoricalScmData  caseStudyRequest = scmCss.getCaseStudy();</span>
<span class="nc" id="L44">    caseStudy = scmHistoricalDataRepository.findByRepoOwnerAndRepoNameAndBranchAndDatesBetween(</span>
<span class="nc" id="L45">        caseStudyRequest.getRepoOwner(),</span>
<span class="nc" id="L46">        caseStudyRequest.getRepoName(),</span>
<span class="nc" id="L47">        caseStudyRequest.getBranch(),</span>
<span class="nc" id="L48">        caseStudyRequest.getStartAt(),</span>
<span class="nc" id="L49">        caseStudyRequest.getEndAt());</span>
<span class="nc" id="L50">    caseStudy.setStartAt(caseStudyRequest.getStartAt());</span>
<span class="nc" id="L51">    caseStudy.setEndAt(caseStudyRequest.getEndAt());</span>

<span class="nc" id="L53">    WebHistoricalScmData simulationRequest = scmCss.getSimulation();</span>
<span class="nc" id="L54">    simulation = scmHistoricalDataRepository.findByRepoOwnerAndRepoNameAndBranchAndDatesBetween(</span>
<span class="nc" id="L55">        simulationRequest.getRepoOwner(),</span>
<span class="nc" id="L56">        simulationRequest.getRepoName(),</span>
<span class="nc" id="L57">        simulationRequest.getBranch(),</span>
<span class="nc" id="L58">        simulationRequest.getStartAt(),</span>
<span class="nc" id="L59">        simulationRequest.getEndAt());</span>
<span class="nc" id="L60">    simulation.setStartAt(simulationRequest.getStartAt());</span>
<span class="nc" id="L61">    simulation.setEndAt(simulationRequest.getEndAt());</span>

    //Features-weight mapping
<span class="nc" id="L64">    EnumMap&lt;Feature, Double&gt; featureWeights = new EnumMap&lt;&gt;(CommitSimilarity.Feature.class);</span>
<span class="nc" id="L65">    log.debug(&quot;files {}  messages {} &quot;, scmCss.getCommitSimilarityFunctionConfig()</span>
<span class="nc" id="L66">        .getFilesWeight(), scmCss.getCommitSimilarityFunctionConfig()</span>
<span class="nc" id="L67">        .getMessageWeight());</span>
<span class="nc" id="L68">    featureWeights.put(CommitSimilarity.Feature.FILES,  scmCss.getCommitSimilarityFunctionConfig()</span>
<span class="nc" id="L69">        .getFilesWeight());</span>
<span class="nc" id="L70">    featureWeights.put(CommitSimilarity.Feature.MESSAGE, scmCss.getCommitSimilarityFunctionConfig()</span>
<span class="nc" id="L71">        .getMessageWeight());</span>
    //calculations
    //teamwork
<span class="nc" id="L74">    Double teamWork = 100*Double.valueOf(</span>
<span class="nc" id="L75">        scmCriteriaService.teamWorkEvaluationBasedOnAlternativeCommits(simulation, scmCss.getParticipants())/(simulation.getCommits().size()));</span>
<span class="nc" id="L76">    Integer teamworkGrade = Rubric.evaluateCriteria(RubricDataGenerator.scmCriteria()</span>
<span class="nc" id="L77">        .getTeamWorkCriteriaScale(), teamWork);</span>
    //commitSimilarity
<span class="nc" id="L79">    Integer similarityThreshold = (int) Math.round(scmCss.getSimilarityThreshold()*100);</span>
<span class="nc" id="L80">    Double commitSimilarity = scmCriteriaService.getCommitSimilarity(</span>
<span class="nc" id="L81">            ScmCaseStudySimulation.builder().caseStudy(caseStudy).simulation(simulation).build(),</span>
          featureWeights,
<span class="nc" id="L83">          similarityThreshold);</span>
<span class="nc" id="L84">    Integer commitSimilarityMark = Rubric.evaluateCriteria(RubricDataGenerator.scmCriteria()</span>
<span class="nc" id="L85">        .getCommitSimilarityCriteriaScale(), commitSimilarity);</span>

<span class="nc" id="L87">    List&lt;CommitComparison&gt; commitComparisons = ScmCaseStudySimulation.builder().caseStudy(caseStudy).simulation(simulation).build().compare(featureWeights, similarityThreshold);</span>
    //issueTraceability
<span class="nc" id="L89">    Double issueTraceability = scmCriteriaService.getCommitsWithIssueTraceability(ScmCaseStudySimulation.builder().caseStudy(caseStudy).simulation(simulation).build());</span>
<span class="nc" id="L90">    Integer issueTraceabilityMark = Rubric.evaluateCriteria(RubricDataGenerator.scmCriteria()</span>
<span class="nc" id="L91">        .getApmIssueTraceabilityCriteriaScale(), issueTraceability);</span>



<span class="nc" id="L95">    ScmWebRubricEvaluation evaluation = ScmWebRubricEvaluation.builder()</span>
<span class="nc" id="L96">        .teamWork(</span>
            new WebRubricCriteriaEvaluation(teamWork, teamworkGrade)
        )
<span class="nc" id="L99">        .similarity(</span>
            new WebRubricCriteriaEvaluation(commitSimilarity,commitSimilarityMark)
        )
<span class="nc" id="L102">        .issueTraceability(</span>
            new WebRubricCriteriaEvaluation(issueTraceability, issueTraceabilityMark)
        )
<span class="nc" id="L105">        .build();</span>

<span class="nc" id="L107">    WebScmCaseStudySimulation result = WebScmCaseStudySimulation.builder()</span>
<span class="nc" id="L108">        .caseStudy(webHistorialScmDataMapper.toDto(caseStudy))</span>
<span class="nc" id="L109">        .simulation(webHistorialScmDataMapper.toDto(simulation))</span>
<span class="nc" id="L110">        .participants(scmCss.getParticipants())</span>
<span class="nc" id="L111">        .commitSimilarityFunctionConfig(scmCss.getCommitSimilarityFunctionConfig())</span>
<span class="nc" id="L112">        .commitComparisons(commitComparisons)</span>
<span class="nc" id="L113">        .similarityThreshold(scmCss.getSimilarityThreshold())</span>
<span class="nc" id="L114">        .rubricEvaluation(evaluation)</span>
<span class="nc" id="L115">        .build();</span>

<span class="nc" id="L117">    return result;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>